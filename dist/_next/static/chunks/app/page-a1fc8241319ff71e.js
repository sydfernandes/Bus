(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{4776:function(e,r,t){Promise.resolve().then(t.bind(t,5364))},5364:function(e,r,t){"use strict";t.r(r),t.d(r,{default:function(){return z}});var a=t(7437),s=t(2265),n=t(166),o=t(7053),l=t(535),i=t(1994),c=t(3335);function d(){for(var e=arguments.length,r=Array(e),t=0;t<e;t++)r[t]=arguments[t];return(0,c.m6)((0,i.W)(r))}let u=(0,l.j)("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",{variants:{variant:{default:"bg-primary text-primary-foreground shadow hover:bg-primary/90",destructive:"bg-destructive text-destructive-foreground shadow-sm hover:bg-destructive/90",outline:"border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground",secondary:"bg-secondary text-secondary-foreground shadow-sm hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-9 px-4 py-2",sm:"h-8 rounded-md px-3 text-xs",lg:"h-10 rounded-md px-8",icon:"h-9 w-9"}},defaultVariants:{variant:"default",size:"default"}}),f=s.forwardRef((e,r)=>{let{className:t,variant:s,size:n,asChild:l=!1,...i}=e,c=l?o.g7:"button";return(0,a.jsx)(c,{className:d(u({variant:s,size:n,className:t})),ref:r,...i})});f.displayName="Button";let m=s.forwardRef((e,r)=>{let{className:t,type:s,...n}=e;return(0,a.jsx)("input",{type:s,className:d("flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-base shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",t),ref:r,...n})});m.displayName="Input";var p=t(7664);let x=s.forwardRef((e,r)=>{let{className:t,children:s,...n}=e;return(0,a.jsxs)(p.fC,{ref:r,className:d("relative overflow-hidden",t),...n,children:[(0,a.jsx)(p.l_,{className:"h-full w-full rounded-[inherit]",children:s}),(0,a.jsx)(h,{}),(0,a.jsx)(p.Ns,{})]})});x.displayName=p.fC.displayName;let h=s.forwardRef((e,r)=>{let{className:t,orientation:s="vertical",...n}=e;return(0,a.jsx)(p.gb,{ref:r,orientation:s,className:d("flex touch-none select-none transition-colors","vertical"===s&&"h-full w-2.5 border-l border-l-transparent p-[1px]","horizontal"===s&&"h-2.5 flex-col border-t border-t-transparent p-[1px]",t),...n,children:(0,a.jsx)(p.q4,{className:"relative flex-1 rounded-full bg-border"})})});h.displayName=p.gb.displayName;var g=t(3247),b=t(7168),v=t(3774),y=t(4438);function N(){return(0,a.jsx)("header",{className:"sticky top-0 z-50 w-full border-b bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60",children:(0,a.jsxs)("div",{className:"container flex h-14 items-center",children:[(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,a.jsx)(v.Z,{className:"h-6 w-6 text-primary"}),(0,a.jsx)("span",{className:"font-bold",children:"BusTracker"})]}),(0,a.jsx)("div",{className:"flex flex-1 items-center justify-end space-x-4",children:(0,a.jsx)("nav",{className:"flex items-center space-x-2"})})]})})}let j=s.forwardRef((e,r)=>{let{className:t,...s}=e;return(0,a.jsx)("div",{ref:r,className:d("rounded-xl border bg-card text-card-foreground shadow",t),...s})});j.displayName="Card",s.forwardRef((e,r)=>{let{className:t,...s}=e;return(0,a.jsx)("div",{ref:r,className:d("flex flex-col space-y-1.5 p-6",t),...s})}).displayName="CardHeader",s.forwardRef((e,r)=>{let{className:t,...s}=e;return(0,a.jsx)("div",{ref:r,className:d("font-semibold leading-none tracking-tight",t),...s})}).displayName="CardTitle",s.forwardRef((e,r)=>{let{className:t,...s}=e;return(0,a.jsx)("div",{ref:r,className:d("text-sm text-muted-foreground",t),...s})}).displayName="CardDescription",s.forwardRef((e,r)=>{let{className:t,...s}=e;return(0,a.jsx)("div",{ref:r,className:d("p-6 pt-0",t),...s})}).displayName="CardContent",s.forwardRef((e,r)=>{let{className:t,...s}=e;return(0,a.jsx)("div",{ref:r,className:d("flex items-center p-6 pt-0",t),...s})}).displayName="CardFooter";let w=(0,l.j)("inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground shadow hover:bg-primary/80",secondary:"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",destructive:"border-transparent bg-destructive text-destructive-foreground shadow hover:bg-destructive/80",outline:"text-foreground"}},defaultVariants:{variant:"default"}});function C(e){let{className:r,variant:t,...s}=e;return(0,a.jsx)("div",{className:d(w({variant:t}),r),...s})}var D=t(6039);function S(e){let{stop:r,isSelected:t,onSelect:s,onLineSelect:n,isLoading:o=!1}=e;return(0,a.jsx)(j,{className:"p-4 cursor-pointer transition-all hover:shadow-md ".concat(t?"ring-2 ring-primary":""),onClick:()=>s(r),children:(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsxs)("div",{className:"flex items-start justify-between",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"font-medium",children:r.name}),r.municipality&&(0,a.jsx)("p",{className:"text-sm text-muted-foreground",children:r.municipality})]}),void 0!==r.distance&&(0,a.jsx)(C,{variant:"secondary",className:"ml-2",children:(0,D.B)(r.distance)})]}),r.lines&&r.lines.length>0&&(0,a.jsx)("div",{className:"flex flex-wrap gap-1 mt-2",children:r.lines.map(e=>(0,a.jsx)(C,{variant:"outline",className:"cursor-pointer hover:bg-primary hover:text-primary-foreground",onClick:r=>{r.stopPropagation(),n(e.idLinea.toString())},children:e.codigo},e.idLinea))}),o&&(0,a.jsx)("div",{className:"flex items-center justify-center py-2",children:(0,a.jsx)("div",{className:"w-4 h-4 border-2 border-primary border-t-transparent rounded-full animate-spin"})})]})})}function k(){return(0,a.jsx)("div",{className:"flex items-center justify-center p-4",children:(0,a.jsx)("div",{className:"h-6 w-6 animate-spin rounded-full border-b-2 border-primary"})})}let E=[],A=[],R=()=>E,_=()=>A,F=(0,n.default)(()=>Promise.all([t.e(126),t.e(212),t.e(815)]).then(t.bind(t,9815)),{loadableGenerated:{webpack:()=>[9815]},ssr:!1}),P=async()=>R(),I=async()=>_(),L=[37.3886303,-5.9953403];function z(){let[e,r]=(0,s.useState)(null),[t,n]=(0,s.useState)(""),[o,l]=(0,s.useState)([]),[i,c]=(0,s.useState)(0),[u,p]=(0,s.useState)(null),[h,j]=(0,s.useState)([]),[w,C]=(0,s.useState)(""),[D,E]=(0,s.useState)(!1),[A,R]=(0,s.useState)(!1),[_,z]=(0,s.useState)(null),U=(0,s.useRef)(!1),B=(0,s.useRef)(!1);(0,s.useRef)(!1);let[M,Z]=(0,s.useState)(!1),[O,T]=(0,s.useState)({}),[q,G]=(0,s.useState)({}),[V,H]=(0,s.useState)(null),[W,J]=(0,s.useState)(!1),[K,Q]=(0,s.useState)(!1),[X,Y]=(0,s.useState)(new Set),$=(0,s.useCallback)(async(e,r)=>{console.log("\uD83D\uDCCD Fetching address for coordinates:",{lat:e,lon:r});try{let t=await fetch("https://nominatim.openstreetmap.org/reverse?format=json&lat=".concat(e,"&lon=").concat(r,"&limit=1")),a=await t.json();console.log("\uD83D\uDCCD Address data received:",a),a.display_name&&n(a.display_name)}catch(e){console.error("❌ Error fetching address:",e)}},[]),ee=(0,s.useCallback)(async e=>{if(!B.current){B.current=!0;try{E(!0);let[r,t]=e,a=await I();l(a),c(a.length)}catch(e){console.error("Error fetching bus stops:",e),y.Am.error("Failed to fetch bus stops")}finally{E(!1),B.current=!1}}},[]),er=(0,s.useCallback)(async()=>{try{return(await navigator.permissions.query({name:"geolocation"})).state}catch(e){return console.error("Error checking permissions:",e),"denied"}},[]),et=(0,s.useCallback)(async()=>{console.log("\uD83C\uDFAF Fetching user location");try{if(!navigator.geolocation)throw Error("Geolocation is not supported by your browser");let e=await er();if(console.log("\uD83D\uDCCD Location permission status:",e),"denied"===e)throw Error("PERMISSION_DENIED");let{latitude:t,longitude:a}=(await new Promise((e,r)=>{navigator.geolocation.getCurrentPosition(e,r,{enableHighAccuracy:!0,timeout:5e3,maximumAge:0})})).coords;console.log("\uD83C\uDFAF User location received:",{latitude:t,longitude:a}),r([t,a]),Z(!1),await Promise.all([$(t,a),ee([t,a])]),y.Am.success("Ubicaci\xf3n Actualizada",{description:"Se han actualizado las paradas cercanas"})}catch(n){console.error("❌ Error getting location:",n),(!e||M)&&(console.log("Using default location:",L),r(L),Z(!0),await Promise.all([$(L[0],L[1]),ee(L)]));let t="No se pudo obtener tu ubicaci\xf3n. Usando ubicaci\xf3n predeterminada.",s=null;"PERMISSION_DENIED"===n.message||1===n.code?(t="Necesitamos acceso a tu ubicaci\xf3n para mostrar las paradas m\xe1s cercanas.",s=(0,a.jsx)(f,{variant:"outline",size:"sm",onClick:()=>{navigator.geolocation.getCurrentPosition(()=>{et()},()=>{})},children:"Permitir Acceso"})):2===n.code?t="No se pudo determinar tu ubicaci\xf3n. Verifica tu conexi\xf3n GPS.":3===n.code&&(t="Se agot\xf3 el tiempo para obtener tu ubicaci\xf3n."),y.Am.error("Error de Ubicaci\xf3n",{description:t,action:s,duration:5e3})}finally{E(!1)}},[$,ee,e,M,er]),ea=(0,s.useCallback)(()=>{console.log("\uD83D\uDD04 Refreshing location"),E(!0),et()},[et]),es=async e=>{try{let r=[];if(O[e.id])r=O[e.id];else{let t=await P();console.log("\uD83D\uDE8C Bus lines raw data:",t),r=Array.isArray(t)?t:[],T(t=>({...t,[e.id]:r}))}return r}catch(e){return console.error("❌ Error fetching lines:",e),y.Am.error("Failed to fetch bus lines"),[]}},en=(0,s.useCallback)(async e=>{if((null==u?void 0:u.id)===e.id){p(null),Y(new Set);return}try{let r={...e,lines:[]};p(r),R(!0),Y(new Set);let t=await es(e),a={...r,lines:t};console.log("\uD83D\uDE8C Updating stop with lines:",a),p(a),l(r=>r.map(r=>r.id===e.id?a:r))}catch(e){console.error("❌ Error:",e),y.Am.error("Error",{description:"No se pudieron obtener las l\xedneas"})}finally{R(!1)}},[u,O]),eo=(0,s.useCallback)(async e=>{try{J(!0);let r="/api/bus-lines/stops?lineId=".concat(e);console.log("\uD83D\uDE8C Fetching line details:",r);let t=await fetch(r);if(!t.ok)throw console.error("❌ Error fetching line details:",t.status,t.statusText),Error("Failed to fetch line details for line ".concat(e));let a=await t.json();return console.log("\uD83D\uDE8C Line details:",a),G(r=>({...r,[e]:a})),a}catch(e){return console.error("❌ Error:",e),y.Am.error("Error",{description:"No se pudieron obtener los detalles de la l\xednea"}),null}finally{J(!1)}},[q]),el=(0,s.useCallback)(e=>Array.isArray(e)?e.map(e=>{let[r,t]=e[0].split(",").map(parseFloat);return isNaN(r)||isNaN(t)?null:[r,t]}).filter(e=>null!==e):[],[]),ei=(0,s.useCallback)(async e=>{try{Q(!0);let r=await fetch("/api/bus-lines/stops?lineId=".concat(e));if(!r.ok)throw Error("Failed to fetch line stops");let t=await r.json();j(t)}catch(e){console.error("Error fetching line stops:",e),y.Am.error("Error",{description:"No se pudieron obtener las paradas de la l\xednea"}),j([])}finally{Q(!1)}},[]),ec=(0,s.useCallback)(async e=>{try{J(!0),H(e);let[r]=await Promise.all([eo(e),ei(e)]);if(r){let e=el(r.polilineaIda||r.polilinea);if(console.log("\uD83D\uDE8C Transformed route points:",e),!e||0===e.length)throw Error("No valid route points found")}}catch(e){console.error("Error handling line selection:",e),y.Am.error("Error",{description:"No se pudieron obtener los detalles de la l\xednea"})}finally{J(!1)}},[eo,ei,el]);(0,s.useCallback)(e=>{Y(r=>{let t=new Set(r);return t.has(e)?t.delete(e):t.add(e),t})},[]),console.log("Current state:",{userLocation:e,address:t,busStopsCount:i,selectedStop:u,isLoading:D}),(0,s.useEffect)(()=>{U.current||(U.current=!0,console.log("\uD83D\uDD04 Initial location fetch"),et())},[et]);let ed=o.filter(e=>{var r;return e.name.toLowerCase().includes(w.toLowerCase())||(null===(r=e.municipality)||void 0===r?void 0:r.toLowerCase().includes(w.toLowerCase()))});return(0,a.jsxs)("div",{className:"min-h-screen flex flex-col",children:[(0,a.jsx)(N,{}),(0,a.jsx)(y.x7,{}),(0,a.jsx)("main",{className:"flex-1 container py-6",children:(0,a.jsxs)("div",{className:"grid gap-6 lg:grid-cols-[350px_1fr] h-[calc(100vh-3.5rem-3rem)]",children:[(0,a.jsxs)("div",{className:"flex flex-col space-y-4",children:[(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,a.jsxs)("div",{className:"relative flex-1",children:[(0,a.jsx)(g.Z,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),(0,a.jsx)(m,{placeholder:"Search stops or area...",value:w,onChange:e=>C(e.target.value),className:"pl-9"})]}),(0,a.jsx)(f,{variant:"outline",size:"icon",onClick:ea,disabled:D,className:"shrink-0",children:(0,a.jsx)(b.Z,{className:d("h-4 w-4",{"animate-spin":D})})})]}),(0,a.jsx)(x,{className:"flex-1 -mx-4 px-4",children:D?(0,a.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,a.jsx)(k,{})}):ed.length>0?(0,a.jsx)("div",{className:"space-y-3",children:ed.map(e=>(0,a.jsx)(S,{stop:e,isSelected:(null==u?void 0:u.id)===e.id,onSelect:()=>en(e),onLineSelect:ec,isLoading:A},e.id))}):(0,a.jsxs)("div",{className:"flex flex-col items-center justify-center h-full text-center",children:[(0,a.jsx)(v.Z,{className:"h-8 w-8 text-muted-foreground mb-2"}),(0,a.jsx)("p",{className:"text-muted-foreground",children:w?"No stops found for your search":"No stops nearby"}),w&&(0,a.jsx)(f,{variant:"ghost",className:"mt-2",onClick:()=>C(""),children:"Clear search"})]})})]}),(0,a.jsx)("div",{className:"relative glass-panel",children:e?(0,a.jsx)(F,{center:e||L,zoom:15,busStops:o,selectedStop:u,onStopSelect:en,onMapInit:z,lineStops:h||[]}):(0,a.jsxs)("div",{className:"flex flex-col items-center justify-center h-full text-center p-4",children:[(0,a.jsx)(v.Z,{className:"h-12 w-12 text-muted-foreground mb-4"}),(0,a.jsx)("h3",{className:"text-lg font-semibold mb-2",children:"Location Access Required"}),(0,a.jsx)("p",{className:"text-muted-foreground mb-4 max-w-md",children:"Please allow location access to find nearby bus stops and get real-time updates"}),(0,a.jsx)(f,{onClick:ea,className:"min-w-[200px]",children:"Enable Location"})]})})]})})]})}},6039:function(e,r,t){"use strict";function a(e){return e<100?"".concat(Math.round(e),"m"):e<1e3?"".concat(10*Math.round(e/10),"m"):"".concat((e/1e3).toFixed(1),"km")}t.d(r,{B:function(){return a}})}},function(e){e.O(0,[314,971,117,744],function(){return e(e.s=4776)}),_N_E=e.O()}]);